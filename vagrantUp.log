$ vagrant up
Bringing machine 'app1' up with 'virtualbox' provider...
Bringing machine 'app2' up with 'virtualbox' provider...
Bringing machine 'web1' up with 'virtualbox' provider...
==> app1: Importing base box 'hashicorp/precise64'...
==> app1: Matching MAC address for NAT networking...
==> app1: Setting the name of the VM: TechnicalTest_app1_1467140778344_80307
==> app1: Clearing any previously set network interfaces...
==> app1: Preparing network interfaces based on configuration...
    app1: Adapter 1: nat
    app1: Adapter 2: hostonly
==> app1: Forwarding ports...
    app1: 22 (guest) => 2222 (host) (adapter 1)
==> app1: Booting VM...
==> app1: Waiting for machine to boot. This may take a few minutes...
    app1: SSH address: 127.0.0.1:2222
    app1: SSH username: vagrant
    app1: SSH auth method: private key
    app1: 
    app1: Vagrant insecure key detected. Vagrant will automatically replace
    app1: this with a newly generated keypair for better security.
    app1: 
    app1: Inserting generated public key within guest...
    app1: Removing insecure key from the guest if it's present...
    app1: Key inserted! Disconnecting and reconnecting using new SSH key...
==> app1: Machine booted and ready!
[app1] GuestAdditions versions on your host (5.0.22) and guest (4.2.0) do not match.
stdin: is not a tty
Reading package lists...
Building dependency tree...
Reading state information...
The following extra packages will be installed:
  fakeroot linux-headers-3.2.0-23 make patch
Suggested packages:
  make-doc diffutils-doc
The following NEW packages will be installed:
  dkms fakeroot linux-headers-3.2.0-23 linux-headers-3.2.0-23-generic make
  patch
0 upgraded, 6 newly installed, 0 to remove and 66 not upgraded.
Need to get 12.7 MB of archives.
After this operation, 68.5 MB of additional disk space will be used.
Get:1 http://us.archive.ubuntu.com/ubuntu/ precise/main make amd64 3.81-8.1ubuntu1 [118 kB]
Get:2 http://us.archive.ubuntu.com/ubuntu/ precise/main patch amd64 2.6.1-3 [80.2 kB]
Get:3 http://us.archive.ubuntu.com/ubuntu/ precise/main dkms all 2.2.0.3-1ubuntu3 [73.1 kB]
Get:4 http://us.archive.ubuntu.com/ubuntu/ precise/main fakeroot amd64 1.18.2-1 [87.2 kB]
Get:5 http://us.archive.ubuntu.com/ubuntu/ precise/main linux-headers-3.2.0-23 all 3.2.0-23.36 [11.4 MB]
Get:6 http://us.archive.ubuntu.com/ubuntu/ precise/main linux-headers-3.2.0-23-generic amd64 3.2.0-23.36 [947 kB]
dpkg-preconfigure: unable to re-open stdin: No such file or directory
Fetched 12.7 MB in 20s (617 kB/s)
Selecting previously unselected package make.
(Reading database ... 51095 files and directories currently installed.)
Unpacking make (from .../make_3.81-8.1ubuntu1_amd64.deb) ...
Selecting previously unselected package patch.
Unpacking patch (from .../patch_2.6.1-3_amd64.deb) ...
Selecting previously unselected package dkms.
Unpacking dkms (from .../dkms_2.2.0.3-1ubuntu3_all.deb) ...
Selecting previously unselected package fakeroot.
Unpacking fakeroot (from .../fakeroot_1.18.2-1_amd64.deb) ...
Selecting previously unselected package linux-headers-3.2.0-23.
Unpacking linux-headers-3.2.0-23 (from .../linux-headers-3.2.0-23_3.2.0-23.36_all.deb) ...
Selecting previously unselected package linux-headers-3.2.0-23-generic.
Unpacking linux-headers-3.2.0-23-generic (from .../linux-headers-3.2.0-23-generic_3.2.0-23.36_amd64.deb) ...
Processing triggers for man-db ...
Setting up make (3.81-8.1ubuntu1) ...
Setting up patch (2.6.1-3) ...
Setting up dkms (2.2.0.3-1ubuntu3) ...
Setting up fakeroot (1.18.2-1) ...
update-alternatives: using /usr/bin/fakeroot-sysv to provide /usr/bin/fakeroot (fakeroot) in auto mode.
Setting up linux-headers-3.2.0-23 (3.2.0-23.36) ...
Setting up linux-headers-3.2.0-23-generic (3.2.0-23.36) ...
Examining /etc/kernel/header_postinst.d.
run-parts: executing /etc/kernel/header_postinst.d/dkms 3.2.0-23-generic /boot/vmlinuz-3.2.0-23-generic
Copy iso file /Applications/VirtualBox.app/Contents/MacOS/VBoxGuestAdditions.iso into the box /tmp/VBoxGuestAdditions.iso
stdin: is not a tty
mount: warning: /mnt seems to be mounted read-only.
Installing Virtualbox Guest Additions 5.0.22 - guest version is 4.2.0
stdin: is not a tty
Verifying archive integrity... All good.
Uncompressing VirtualBox 5.0.22 Guest Additions for Linux............
VirtualBox Guest Additions installer
Removing installed version 4.2.0 of VirtualBox Guest Additions...
Copying additional installer modules ...
Installing additional modules ...
Removing existing VirtualBox DKMS kernel modules ...done.
Removing existing VirtualBox non-DKMS kernel modules ...done.
Building the VirtualBox Guest Additions kernel modules ...done.
Doing non-kernel setup of the Guest Additions ...done.
You should restart your guest to make sure the new modules are actually used

stdin: is not a tty
vagrant_vbguest.machine_loop_guard
==> app1: Checking for guest additions in VM...
==> app1: Configuring and enabling network interfaces...
==> app1: Running provisioner: ansible...
    app1: Running ansible-playbook...

PLAY [appserver] ***************************************************************

TASK [setup] *******************************************************************
ok: [app1]

TASK [common : Ensure hostname set] ********************************************
changed: [app1]

TASK [common : Ensure /etc/hosts populated] ************************************
changed: [app1]

TASK [common : Run apt-get update to refresh package source list] **************
ok: [app1]

TASK [appNodePackages : Ensure Git is installed] *******************************
changed: [app1]

TASK [appNodePackages : Ensure Go language is installed] ***********************
changed: [app1]

TASK [appServiceAccount : Create application service account] ******************
changed: [app1]

TASK [appServiceAccount : Install testapp service helper file] *****************
changed: [app1]

TASK [appDeployment : Ensure testapp service is stopped for code installation] *
ok: [app1]

TASK [appDeployment : Ensure there are no previous deployment files] ***********
ok: [app1]

TASK [appDeployment : Git checkout of code] ************************************
changed: [app1]

TASK [appDeployment : Build testapp.go] ****************************************
changed: [app1]

TASK [appDeployment : Build broken testapp.go] *********************************
skipping: [app1]

TASK [appDeployment : restart testapp service] *********************************
changed: [app1]

PLAY [webserver] ***************************************************************
skipping: no hosts matched

PLAY [Test end to end application availability] ********************************
skipping: no hosts matched

PLAY RECAP *********************************************************************
app1                       : ok=13   changed=9    unreachable=0    failed=0   

==> app2: Importing base box 'hashicorp/precise64'...
==> app2: Matching MAC address for NAT networking...
==> app2: Setting the name of the VM: TechnicalTest_app2_1467141030272_55878
==> app2: Fixed port collision for 22 => 2222. Now on port 2200.
==> app2: Clearing any previously set network interfaces...
==> app2: Preparing network interfaces based on configuration...
    app2: Adapter 1: nat
    app2: Adapter 2: hostonly
==> app2: Forwarding ports...
    app2: 22 (guest) => 2200 (host) (adapter 1)
==> app2: Booting VM...
==> app2: Waiting for machine to boot. This may take a few minutes...
    app2: SSH address: 127.0.0.1:2200
    app2: SSH username: vagrant
    app2: SSH auth method: private key
    app2: 
    app2: Vagrant insecure key detected. Vagrant will automatically replace
    app2: this with a newly generated keypair for better security.
    app2: 
    app2: Inserting generated public key within guest...
    app2: Removing insecure key from the guest if it's present...
    app2: Key inserted! Disconnecting and reconnecting using new SSH key...
==> app2: Machine booted and ready!
[app2] GuestAdditions versions on your host (5.0.22) and guest (4.2.0) do not match.
stdin: is not a tty
Reading package lists...
Building dependency tree...
Reading state information...
The following extra packages will be installed:
  fakeroot linux-headers-3.2.0-23 make patch
Suggested packages:
  make-doc diffutils-doc
The following NEW packages will be installed:
  dkms fakeroot linux-headers-3.2.0-23 linux-headers-3.2.0-23-generic make
  patch
0 upgraded, 6 newly installed, 0 to remove and 66 not upgraded.
Need to get 12.7 MB of archives.
After this operation, 68.5 MB of additional disk space will be used.
Get:1 http://us.archive.ubuntu.com/ubuntu/ precise/main make amd64 3.81-8.1ubuntu1 [118 kB]
Get:2 http://us.archive.ubuntu.com/ubuntu/ precise/main patch amd64 2.6.1-3 [80.2 kB]
Get:3 http://us.archive.ubuntu.com/ubuntu/ precise/main dkms all 2.2.0.3-1ubuntu3 [73.1 kB]
Get:4 http://us.archive.ubuntu.com/ubuntu/ precise/main fakeroot amd64 1.18.2-1 [87.2 kB]
Get:5 http://us.archive.ubuntu.com/ubuntu/ precise/main linux-headers-3.2.0-23 all 3.2.0-23.36 [11.4 MB]
Get:6 http://us.archive.ubuntu.com/ubuntu/ precise/main linux-headers-3.2.0-23-generic amd64 3.2.0-23.36 [947 kB]
dpkg-preconfigure: unable to re-open stdin: No such file or directory
Fetched 12.7 MB in 18s (685 kB/s)
Selecting previously unselected package make.
(Reading database ... 51095 files and directories currently installed.)
Unpacking make (from .../make_3.81-8.1ubuntu1_amd64.deb) ...
Selecting previously unselected package patch.
Unpacking patch (from .../patch_2.6.1-3_amd64.deb) ...
Selecting previously unselected package dkms.
Unpacking dkms (from .../dkms_2.2.0.3-1ubuntu3_all.deb) ...
Selecting previously unselected package fakeroot.
Unpacking fakeroot (from .../fakeroot_1.18.2-1_amd64.deb) ...
Selecting previously unselected package linux-headers-3.2.0-23.
Unpacking linux-headers-3.2.0-23 (from .../linux-headers-3.2.0-23_3.2.0-23.36_all.deb) ...
Selecting previously unselected package linux-headers-3.2.0-23-generic.
Unpacking linux-headers-3.2.0-23-generic (from .../linux-headers-3.2.0-23-generic_3.2.0-23.36_amd64.deb) ...
Processing triggers for man-db ...
Setting up make (3.81-8.1ubuntu1) ...
Setting up patch (2.6.1-3) ...
Setting up dkms (2.2.0.3-1ubuntu3) ...
Setting up fakeroot (1.18.2-1) ...
update-alternatives: using /usr/bin/fakeroot-sysv to provide /usr/bin/fakeroot (fakeroot) in auto mode.
Setting up linux-headers-3.2.0-23 (3.2.0-23.36) ...
Setting up linux-headers-3.2.0-23-generic (3.2.0-23.36) ...
Examining /etc/kernel/header_postinst.d.
run-parts: executing /etc/kernel/header_postinst.d/dkms 3.2.0-23-generic /boot/vmlinuz-3.2.0-23-generic
Copy iso file /Applications/VirtualBox.app/Contents/MacOS/VBoxGuestAdditions.iso into the box /tmp/VBoxGuestAdditions.iso
stdin: is not a tty
mount: warning: /mnt seems to be mounted read-only.
Installing Virtualbox Guest Additions 5.0.22 - guest version is 4.2.0
stdin: is not a tty
Verifying archive integrity... All good.
Uncompressing VirtualBox 5.0.22 Guest Additions for Linux............
VirtualBox Guest Additions installer
Removing installed version 4.2.0 of VirtualBox Guest Additions...
Copying additional installer modules ...
Installing additional modules ...
Removing existing VirtualBox DKMS kernel modules ...done.
Removing existing VirtualBox non-DKMS kernel modules ...done.
Building the VirtualBox Guest Additions kernel modules ...done.
Doing non-kernel setup of the Guest Additions ...done.
You should restart your guest to make sure the new modules are actually used

stdin: is not a tty
vagrant_vbguest.machine_loop_guard
==> app2: Checking for guest additions in VM...
==> app2: Configuring and enabling network interfaces...
==> app2: Running provisioner: ansible...
    app2: Running ansible-playbook...

PLAY [appserver] ***************************************************************

TASK [setup] *******************************************************************
ok: [app1]
ok: [app2]

TASK [common : Ensure hostname set] ********************************************
ok: [app1]
changed: [app2]

TASK [common : Ensure /etc/hosts populated] ************************************
changed: [app1]
changed: [app2]

TASK [common : Run apt-get update to refresh package source list] **************
ok: [app1]
ok: [app2]

TASK [appNodePackages : Ensure Git is installed] *******************************
ok: [app1]
changed: [app2]

TASK [appNodePackages : Ensure Go language is installed] ***********************
ok: [app1]
changed: [app2]

TASK [appServiceAccount : Create application service account] ******************
ok: [app1]
changed: [app2]

TASK [appServiceAccount : Install testapp service helper file] *****************
changed: [app2]
ok: [app1]

TASK [appDeployment : Ensure testapp service is stopped for code installation] *
changed: [app1]
ok: [app2]

TASK [appDeployment : Ensure there are no previous deployment files] ***********
changed: [app1]
ok: [app2]

TASK [appDeployment : Git checkout of code] ************************************
ok: [app1]
changed: [app2]

TASK [appDeployment : Build testapp.go] ****************************************
changed: [app1]
changed: [app2]

TASK [appDeployment : Build broken testapp.go] *********************************
skipping: [app1]
skipping: [app2]

TASK [appDeployment : restart testapp service] *********************************
changed: [app1]
changed: [app2]

PLAY [webserver] ***************************************************************
skipping: no hosts matched

PLAY [Test end to end application availability] ********************************
skipping: no hosts matched

PLAY RECAP *********************************************************************
app1                       : ok=13   changed=5    unreachable=0    failed=0   
app2                       : ok=13   changed=9    unreachable=0    failed=0   

==> web1: Importing base box 'hashicorp/precise64'...
==> web1: Matching MAC address for NAT networking...
==> web1: Setting the name of the VM: TechnicalTest_web1_1467141261966_87766
==> web1: Fixed port collision for 22 => 2222. Now on port 2201.
==> web1: Clearing any previously set network interfaces...
==> web1: Preparing network interfaces based on configuration...
    web1: Adapter 1: nat
    web1: Adapter 2: hostonly
==> web1: Forwarding ports...
    web1: 22 (guest) => 2201 (host) (adapter 1)
==> web1: Booting VM...
==> web1: Waiting for machine to boot. This may take a few minutes...
    web1: SSH address: 127.0.0.1:2201
    web1: SSH username: vagrant
    web1: SSH auth method: private key
    web1: 
    web1: Vagrant insecure key detected. Vagrant will automatically replace
    web1: this with a newly generated keypair for better security.
    web1: 
    web1: Inserting generated public key within guest...
    web1: Removing insecure key from the guest if it's present...
    web1: Key inserted! Disconnecting and reconnecting using new SSH key...
==> web1: Machine booted and ready!
[web1] GuestAdditions versions on your host (5.0.22) and guest (4.2.0) do not match.
stdin: is not a tty
Reading package lists...
Building dependency tree...
Reading state information...
The following extra packages will be installed:
  fakeroot linux-headers-3.2.0-23 make patch
Suggested packages:
  make-doc diffutils-doc
The following NEW packages will be installed:
  dkms fakeroot linux-headers-3.2.0-23 linux-headers-3.2.0-23-generic make
  patch
0 upgraded, 6 newly installed, 0 to remove and 66 not upgraded.
Need to get 12.7 MB of archives.
After this operation, 68.5 MB of additional disk space will be used.
Get:1 http://us.archive.ubuntu.com/ubuntu/ precise/main make amd64 3.81-8.1ubuntu1 [118 kB]
Get:2 http://us.archive.ubuntu.com/ubuntu/ precise/main patch amd64 2.6.1-3 [80.2 kB]
Get:3 http://us.archive.ubuntu.com/ubuntu/ precise/main dkms all 2.2.0.3-1ubuntu3 [73.1 kB]
Get:4 http://us.archive.ubuntu.com/ubuntu/ precise/main fakeroot amd64 1.18.2-1 [87.2 kB]
Get:5 http://us.archive.ubuntu.com/ubuntu/ precise/main linux-headers-3.2.0-23 all 3.2.0-23.36 [11.4 MB]
Get:6 http://us.archive.ubuntu.com/ubuntu/ precise/main linux-headers-3.2.0-23-generic amd64 3.2.0-23.36 [947 kB]
dpkg-preconfigure: unable to re-open stdin: No such file or directory
Fetched 12.7 MB in 27s (456 kB/s)
Selecting previously unselected package make.
(Reading database ... 51095 files and directories currently installed.)
Unpacking make (from .../make_3.81-8.1ubuntu1_amd64.deb) ...
Selecting previously unselected package patch.
Unpacking patch (from .../patch_2.6.1-3_amd64.deb) ...
Selecting previously unselected package dkms.
Unpacking dkms (from .../dkms_2.2.0.3-1ubuntu3_all.deb) ...
Selecting previously unselected package fakeroot.
Unpacking fakeroot (from .../fakeroot_1.18.2-1_amd64.deb) ...
Selecting previously unselected package linux-headers-3.2.0-23.
Unpacking linux-headers-3.2.0-23 (from .../linux-headers-3.2.0-23_3.2.0-23.36_all.deb) ...
Selecting previously unselected package linux-headers-3.2.0-23-generic.
Unpacking linux-headers-3.2.0-23-generic (from .../linux-headers-3.2.0-23-generic_3.2.0-23.36_amd64.deb) ...
Processing triggers for man-db ...
Setting up make (3.81-8.1ubuntu1) ...
Setting up patch (2.6.1-3) ...
Setting up dkms (2.2.0.3-1ubuntu3) ...
Setting up fakeroot (1.18.2-1) ...
update-alternatives: using /usr/bin/fakeroot-sysv to provide /usr/bin/fakeroot (fakeroot) in auto mode.
Setting up linux-headers-3.2.0-23 (3.2.0-23.36) ...
Setting up linux-headers-3.2.0-23-generic (3.2.0-23.36) ...
Examining /etc/kernel/header_postinst.d.
run-parts: executing /etc/kernel/header_postinst.d/dkms 3.2.0-23-generic /boot/vmlinuz-3.2.0-23-generic
Copy iso file /Applications/VirtualBox.app/Contents/MacOS/VBoxGuestAdditions.iso into the box /tmp/VBoxGuestAdditions.iso
stdin: is not a tty
mount: warning: /mnt seems to be mounted read-only.
Installing Virtualbox Guest Additions 5.0.22 - guest version is 4.2.0
stdin: is not a tty
Verifying archive integrity... All good.
Uncompressing VirtualBox 5.0.22 Guest Additions for Linux............
VirtualBox Guest Additions installer
Removing installed version 4.2.0 of VirtualBox Guest Additions...
Copying additional installer modules ...
Installing additional modules ...
Removing existing VirtualBox DKMS kernel modules ...done.
Removing existing VirtualBox non-DKMS kernel modules ...done.
Building the VirtualBox Guest Additions kernel modules ...done.
Doing non-kernel setup of the Guest Additions ...done.
You should restart your guest to make sure the new modules are actually used

stdin: is not a tty
vagrant_vbguest.machine_loop_guard
==> web1: Checking for guest additions in VM...
==> web1: Configuring and enabling network interfaces...
==> web1: Running provisioner: ansible...
    web1: Running ansible-playbook...

PLAY [appserver] ***************************************************************

TASK [setup] *******************************************************************
ok: [app1]
ok: [app2]

TASK [common : Ensure hostname set] ********************************************
ok: [app1]
ok: [app2]

TASK [common : Ensure /etc/hosts populated] ************************************
ok: [app1]
ok: [app2]

TASK [common : Run apt-get update to refresh package source list] **************
ok: [app1]
ok: [app2]

TASK [appNodePackages : Ensure Git is installed] *******************************
ok: [app1]
ok: [app2]

TASK [appNodePackages : Ensure Go language is installed] ***********************
ok: [app1]
ok: [app2]

TASK [appServiceAccount : Create application service account] ******************
ok: [app1]
ok: [app2]

TASK [appServiceAccount : Install testapp service helper file] *****************
ok: [app1]
ok: [app2]

TASK [appDeployment : Ensure testapp service is stopped for code installation] *
changed: [app1]
changed: [app2]

TASK [appDeployment : Ensure there are no previous deployment files] ***********
changed: [app1]
changed: [app2]

TASK [appDeployment : Git checkout of code] ************************************
ok: [app2]
ok: [app1]

TASK [appDeployment : Build testapp.go] ****************************************
changed: [app1]
changed: [app2]

TASK [appDeployment : Build broken testapp.go] *********************************
skipping: [app1]
skipping: [app2]

TASK [appDeployment : restart testapp service] *********************************
changed: [app1]
changed: [app2]

PLAY [webserver] ***************************************************************

TASK [setup] *******************************************************************
ok: [web1]

TASK [common : Ensure hostname set] ********************************************
changed: [web1]

TASK [common : Ensure /etc/hosts populated] ************************************
changed: [web1]

TASK [common : Run apt-get update to refresh package source list] **************
ok: [web1]

TASK [webNodePackages : Ensure nginx is installed] *****************************
changed: [web1]

TASK [webNodePackages : Create nginx.conf from template] ***********************
changed: [web1]

TASK [webNodePackages : Wait for app servers to become responsive] *************
ok: [web1] => (item=app1)
ok: [web1] => (item=app2)

TASK [webNodePackages : Ensure nginx running] **********************************
changed: [web1]

PLAY [Test end to end application availability] ********************************

TASK [setup] *******************************************************************
ok: [web1]

TASK [Testing load balancing on nginx] *****************************************
changed: [web1 -> localhost]

TASK [debug] *******************************************************************
ok: [web1] => {
    "msg": "Hi there, I'm served from app2!\nHi there, I'm served from app1!\nHi there, I'm served from app2!\nHi there, I'm served from app1!\nHi there, I'm served from app2!\nHi there, I'm served from app1!"
}

TASK [Check each app node is in the web response] ******************************
skipping: [web1] => (item=app1) 
skipping: [web1] => (item=app2) 

PLAY RECAP *********************************************************************
app1                       : ok=13   changed=4    unreachable=0    failed=0   
app2                       : ok=13   changed=4    unreachable=0    failed=0   
web1                       : ok=11   changed=6    unreachable=0    failed=0   

$ 
